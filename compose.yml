# Docker Compose file for dt-demo-gcp
# Local development environment

# In the initial stage, we will want to run a full local stack.
# In later stages, we may only want to run a specific service locally for development while
# connecting to other services in the cloud -- use `docker compose up <service_name>` to
# launch a specific service.

name: dt-demo-gcp

services:

  # Miniature file server for static files
  # Server doesn't handle base paths, so we mount the files at /public/dev-docs
  # and keep the path prefix (no stripping)
  dev-docs:
    image: europe-west2-docker.pkg.dev/cambridge-ifm/dt-demo-gcp/dev-docs:latest
    restart: always
    profiles:
    - default # Launch service if no profile is specified
    - docs    # Part of documentation service group
    labels:
    - "traefik.enable=true"
    - "traefik.http.routers.dev-docs.rule=PathPrefix(`/dev-docs`)"


  # Traefik reverse proxy
  traefik:
    image: traefik:v3
    restart: always
    profiles:
      - default # Launch service if no profile is specified
      - infra   # Part of infrastructure group
    ports:
      - "80:80" # HTTP
      - "443:443" # HTTPS
      - "10000:8080" # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./traefik/traefik.yml:/traefik.yml:ro
    healthcheck:
      # Ping port 8080 (Traefik self endpoint, maps to 10000 externally)
      test: ["CMD-SHELL", "traefik healthcheck &> /dev/null"]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 30s

  # Authentication service
  # FastAPI server (auth); PostgreSQL database (db-auth)
  # /token for login, /validate for token validation
  # /validate is used for ForwardAuth (Traefik)
  auth:
    image: europe-west2-docker.pkg.dev/cambridge-ifm/dt-demo-gcp/auth:latest
    restart: always
    profiles:
      - default # Launch service if no profile is specified
      - auth    # Part of authentication service group
    environment:
      - DB_HOST=auth-postgres  # Use Docker internal hostname
      - DB_PORT=5432  # Use internal port number
      - TOKEN_URL=http://auth:8000/token  # Use Docker internal hostname
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.auth.rule=PathPrefix(`/`)"

    # Set the root path for the FastAPI application (change as needed)
    command: ["--root-path", ""]
  auth-postgres:  # Database for auth service
    profiles:
      - default # Launch service if no profile is specified
      - auth    # Part of authentication service group
      - db      # Is a database
    image: postgres:17-bookworm
    restart: always
    env_file:
      - dt-demo-gcp-db-auth/.env
    ports:
      - "30001:5432"
    volumes:
      # Uncomment line below if needed to initialize database
      # (unnecessary unless db-auth-data volume is deleted)
      # - ./dt-demo-gcp-db-auth/secret/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - db-auth-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h localhost -U postgres -d auth &> /dev/null"]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 30s
  auth-redis:  # Redis for auth service
    profiles:
      - default # Launch service if no profile is specified
      - auth    # Part of authentication service group
      - redis
    image: redis:8-bookworm
    restart: always
    ports:
      - "30002:6379"
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping &> /dev/null"]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 30s


  # Login page (static site built with Vite)
  login:
    image: europe-west2-docker.pkg.dev/cambridge-ifm/dt-demo-gcp/login:latest
    restart: always
    profiles:
      - default   # Launch service if no profile is specified
      - frontend  # Serves a webpage or set of web pages
      - auth      # Part of authentication service group
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.login.rule=PathPrefix(`/login`)"
      - "traefik.http.routers.login.middlewares=login-strip-prefix"
      - "traefik.http.middlewares.login-strip-prefix.stripprefix.prefixes=/login"
    environment:
      - VITE_TOKEN_URL=http://localhost/token
      - VITE_REDIRECT_URL=http://localhost/validate

networks:
  default:
    name: dt-demo-net
    driver: bridge
    attachable: true

volumes:
  db-auth-data:
  # Example for NFS mount -- ensure nfs-common is installed on the Docker host
  # For GCS, see: https://cloud.google.com/filestore/docs/create-instance-gcloud#create-filestore-instance
  # dt-volume:
    # driver: local
    # driver_opts:
    #   type: nfs
    #   o: "addr=10.40.0.199,rw,nfsvers=4,async"
    #   device: ":/docker/example"
